# Co-Write Client - Automerge Integration

–ö–ª—ñ—î–Ω—Ç—Å—å–∫–∞ —á–∞—Å—Ç–∏–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º Automerge CRDT.

## üöÄ –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### 1. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π

```bash
npm install
```

### 2. –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞

```bash
npx vite --host
```

–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –Ω–∞ `http://localhost:5173` (–∞–±–æ —ñ–Ω—à–æ–º—É –ø–æ—Ä—Ç—É, —è–∫—â–æ –∑–∞–π–Ω—è—Ç–∏–π).

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó

### –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞

1. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ backend —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π:
   ```bash
   cd ../server
   cargo run
   ```

2. Backend –º–∞—î –±—É—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω–∏–π –Ω–∞ `http://localhost:8080`

### –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è multi-user —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó

1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ `http://localhost:5173/client/index.html` –≤ –±—Ä–∞—É–∑–µ—Ä—ñ
2. –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –¥–æ–∫—É–º–µ–Ω—Ç
3. –°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç
4. –í—ñ–¥–∫—Ä–∏–π—Ç–µ —Ç–µ —Å–∞–º–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤ **2-3 –Ω–æ–≤–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö** –±—Ä–∞—É–∑–µ—Ä–∞
5. –ü–æ—á–Ω—ñ—Ç—å –æ–¥–Ω–æ—á–∞—Å–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç —É —Ä—ñ–∑–Ω–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö
6. –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞–π—Ç–µ –∑–∞ **–º–∏—Ç—Ç—î–≤–æ—é —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—î—é** –º—ñ–∂ –≤—Å—ñ–º–∞ –∫–ª—ñ—î–Ω—Ç–∞–º–∏!

### –©–æ –æ—á—ñ–∫—É–≤–∞—Ç–∏

- ‚úÖ –ó–º—ñ–Ω–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ä–æ–∑–≤'—è–∑–∞–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ —á–µ—Ä–µ–∑ CRDT
- ‚úÖ –ü–æ–∑–∏—Ü—ñ—è –∫—É—Ä—Å–æ—Ä–∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è—Ö
- ‚úÖ –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –º–µ—Ä–µ–∂–µ–≤–∏–π —Ç—Ä–∞—Ñ—ñ–∫ (—Ç—ñ–ª—å–∫–∏ –¥–µ–ª—å—Ç–∏)

## üõ† –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó

- **Automerge** - CRDT –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–æ–∑–≤'—è–∑–∞–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤
- **WebSocket** - –±—ñ–Ω–∞—Ä–Ω–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è sync messages
- **Vite** - —à–≤–∏–¥–∫–∏–π dev —Å–µ—Ä–≤–µ—Ä –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é WASM

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
client/
‚îú‚îÄ‚îÄ editor.html           # –°—Ç–æ—Ä—ñ–Ω–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
‚îú‚îÄ‚îÄ index.html           # –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ editor.js    # –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ –∑ Automerge
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ paths.js     # API endpoints
‚îÇ   ‚îî‚îÄ‚îÄ other/
‚îÇ       ‚îî‚îÄ‚îÄ showToast.js # UI utilities
‚îú‚îÄ‚îÄ styles.css           # –°—Ç–∏–ª—ñ
‚îî‚îÄ‚îÄ vite.config.js       # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Vite + WASM
```

### Automerge Flow

1. –ü—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ –∫–ª—ñ—î–Ω—Ç —Å—Ç–≤–æ—Ä—é—î Automerge –¥–æ–∫—É–º–µ–Ω—Ç –∑ `Text` –ø–æ–ª–µ–º
2. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è `syncState` –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
3. –ü—Ä–∏ –≤–≤–µ–¥–µ–Ω–Ω—ñ —Ç–µ–∫—Å—Ç—É:
   - –û–±—á–∏—Å–ª—é—î—Ç—å—Å—è diff —á–µ—Ä–µ–∑ common prefix/suffix –∞–ª–≥–æ—Ä–∏—Ç–º
   - –ó–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –∑–º—ñ–Ω–∏: `doc.content.deleteAt()` / `insertAt()`
   - –ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è sync message —á–µ—Ä–µ–∑ `generateSyncMessage()`
   - –í—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä —è–∫ –±—ñ–Ω–∞—Ä–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
4. –ü—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –∑–º—ñ–Ω:
   - –ü–∞—Ä—Å–∏—Ç—å—Å—è –±—ñ–Ω–∞—Ä–Ω–µ sync message
   - –ó–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `receiveSyncMessage()`
   - –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è UI –∑—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º –∫—É—Ä—Å–æ—Ä–∞

## üì¶ –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

### Production
- `@automerge/automerge` - CRDT sync engine
- `ws` - WebSocket library

### Development
- `vite` - Dev server
- `vite-plugin-wasm` - WASM –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –¥–ª—è Vite
- `vite-plugin-top-level-await` - Top-level await –¥–ª—è WASM

## üêõ Troubleshooting

### WASM –ø–æ–º–∏–ª–∫–∞ –≤ Vite

–Ø–∫—â–æ –±–∞—á–∏—Ç–µ –ø–æ–º–∏–ª–∫—É "ESM integration proposal for Wasm is not supported":

```bash
npm install -D vite-plugin-wasm vite-plugin-top-level-await
```

–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ `vite.config.js` –º—ñ—Å—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –ø–ª–∞–≥—ñ–Ω–∏.

### WebSocket –Ω–µ –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ:
1. Backend —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π –Ω–∞ –ø–æ—Ä—Ç—É 8080
2. –í `scripts/core/paths.js` –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π URL
3. –í –∫–æ–Ω—Å–æ–ª—ñ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–µ–º–∞—î CORS –ø–æ–º–∏–ª–æ–∫

### –¢–µ–∫—Å—Ç –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è

1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ DevTools ‚Üí Network ‚Üí WS
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—é—Ç—å—Å—è binary messages
3. –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ Console –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫ Automerge

## üìù –ü—Ä–∏–º—ñ—Ç–∫–∏

- –°–µ—Ä–≤–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Rust + Actix –¥–ª—è –æ–±—Ä–æ–±–∫–∏ sync messages
- –ó–º—ñ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ PostgreSQL
- Merge daemon –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ –∫–æ–Ω—Å–æ–ª—ñ–¥—É—î –∑–º—ñ–Ω–∏ –∫–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω

